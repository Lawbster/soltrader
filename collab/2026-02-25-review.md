# Sol-trader — Codex Review: Sweep Refactor + Exit Signal Analysis
**Date:** 2026-02-25
**Author:** Claude (via session with Emil)
**Scope:** Sweep template refactor (implemented), live vs. backtest exit disconnect (proposed), ADX gate (proposed)

---

## 1. What Was Implemented This Session

### sweep.ts — Templates refactored

**Grids tightened (already live in repo):**
- `rsi`: entry `[10..40]` → `[20,25,30,35]`, exit `[55..90]` → `[70,75,85]`, sl `[-0.5..-5]` → `[-3,-5]`, tp unchanged minus weak values
- `crsi`: entry `[2..35]` → `[10,15,20]`, exit `[55..95]` → `[90,95]`, sl → `[-3,-5]`, tp → `[3,4,6,8,10]`

**Dead templates moved to `_disabledTemplates` array (code preserved, not active):**
- `macd-obv`, `rsi2`, `ema-adx`, `multi` — zero positive rows in 2026-02-24 full-day sweep

**Five new templates added (already live):**
- `rsi-crsi-confluence` — requires both RSI < entryRsi AND CRSI < entryCrsi simultaneously
- `crsi-dip-recover` — enters on CRSI recovery from extreme (prev < dip AND current >= recover)
- `trend-pullback-rsi` — RSI oversold only when price > SMA50 (bullish structure gate)
- `vwap-rsi-reclaim` — price crosses above vwapProxy from below + RSI gate; uses `ctx.history[ctx.index-1]?.close` for prevClose (no engine changes needed)
- `bb-rsi-crsi-reversal` — price at BB lower + RSI + CRSI triple confluence

**sweep-candidates.ts:** `coreMinProfitFactor` raised 1.1 → 1.2 per Codex recommendation.

**Total combos after refactor:** ~3111/token (was ~6000+)

---

## 2. Live vs. Backtest Exit Disconnect (Unresolved — Codex review needed)

### What rules.ts shows

`evaluateEntry` for per-token strategy (line 113–175 in rules.ts):
- Checks only: `rsi < entry` (RSI mode) or `connorsRsi < entry` (CRSI mode)
- **No ADX gate. No SMA filter. No volume confirmation.**

`evaluateExit` (line 204–282):
- Called only for OLD positions without `strategyPlan`
- Parameters: `currentPnlPct`, `peakPnlPct`, `holdTimeMinutes`, `liquidityChangePct`, `tp1Hit`, `tp2Hit`
- **No indicator input at all. No RSI. No CRSI.**

Per-token positions (those with `strategyPlan`):
- Exit at `sl%` (hard stop) or `tp%` (take profit) — price-only, handled in position-manager.ts
- `strategyPlan.exit` field exists in the type but is **never checked at exit time** — it's described as "stored for reference (sweep source)"

### The disconnect

Every sweep template has an indicator-based sell condition (e.g., `if rsi > p.exit return 'sell'`). This fires during a backtest. But in live, per-token positions have **no indicator-based exit** — only price SL/TP.

This means:
- Sweep is modeling: enter on indicator oversold → exit on indicator recovery OR price target/stop
- Live is doing: enter on indicator oversold → exit on price target/stop ONLY

For tight TPs (e.g., PIPPIN tp=3%), the price TP fires before RSI ever recovers to exit=95, so the disconnect is minor. For wider TPs (e.g., HNT tp=10%), the indicator exit may fire first in sweep runs, which would NOT happen in live. This causes backtest to overstate trade count and understate hold time for those cases.

**This is worth quantifying:** how often does the indicator exit fire before the price TP in sweep runs for HNT/BONK?

---

## 3. Proposed New Template: `rsi-crsi-midpoint-exit`

### Motivation

Research finding (multiple 2025 sources, confirmed): exiting when RSI crosses above 50 (midpoint recovery) outperforms holding for RSI > 70-90 on a risk-adjusted basis. The fastest recovery gain happens in the first 50% of the bounce. Holding for RSI overbought exposes the position to a "second leg down" before RSI gets there.

This is a hypothesis worth testing in the sweep before committing to a live change.

### Proposed template

```
Name: rsi-crsi-midpoint-exit
Entry: rsi < entryRsi AND connorsRsi < entryCrsi (same as confluence)
Exit:  rsi > 50 (midpoint — fixed, no grid param)
SL:    parameterized [-2, -3, -5]
TP:    none (rely on RSI-50 indicator exit + SL; no price target)
```

Grid:
```
entryRsi:  [20, 25, 30]
entryCrsi: [10, 15, 20]
sl:        [-2, -3, -5]
```

Combos: 3×3×3 = 27. Fast to run.

Evaluate logic:
```typescript
evaluate(ctx): Signal {
  const { rsi, connorsRsi } = ctx.indicators;
  if (rsi === undefined || connorsRsi === undefined) return 'hold';
  if (ctx.positions.length > 0 && rsi > 50) return 'sell';
  if (rsi < p.entryRsi && connorsRsi < p.entryCrsi) return 'buy';
  return 'hold';
}
```

**No `stopLossPct` or `takeProfitPct` on the strategy object** — rely solely on the RSI-50 indicator exit and the engine's SL.
(The engine handles intra-bar SL via `strategy.stopLossPct` — this would still be set from `p.sl`.)

### What this tells us

If `rsi-crsi-midpoint-exit` outperforms `rsi-crsi-confluence` on the same tokens/regimes in back-test:
- It validates the RSI-50 exit concept for this basket
- It opens the door to adding an indicator-based exit to the live bot (not just SL/TP)
- The live implementation would require passing `rsi` to position-manager's update loop and firing an exit when RSI > 50 while in a per-token position

If it doesn't outperform: the current SL/TP-only approach is fine and we drop this line of investigation.

---

## 4. Proposed: ADX Entry Gate

### Motivation

ADX(14) < 25 = ranging market (mean-reversion valid). ADX > 25 = trending (mean-reversion high risk of continuation loss). The live bot currently has no protection against entering a mean-reversion trade during a momentum dump.

### Two ways to test this

**Option A — Sweep template (no live change):**
Add `adx-gate` variants of existing templates:
```
Entry: rsi < entryRsi AND adx < adxMax
SL/TP: same as base template
Grid adxMax: [20, 25, 30]
```
This quantifies whether ADX gate actually helps on this token basket.

**Option B — Live entry gate in rules.ts:**
In `evaluateEntry`, after the indicator check (line ~113), add:
```typescript
const adxGate = cfg.entry.adxGate; // new config field, default 0 (disabled)
if (adxGate > 0 && indicators?.adx !== undefined && indicators.adx > adxGate) {
  return { ..., passed: false, reason: `ADX ${indicators.adx.toFixed(1)} > ${adxGate} (trending, skip entry)` };
}
```

This requires:
1. `adx` added to `indicators` param in `evaluateEntry` signature
2. `adx` computed in `getIndicatorSnapshot` (src/analysis/indicators.ts) — need to verify if ADX is currently computed there
3. `adxGate` field added to `strategy.v1.json` (entry section)

**Recommendation:** Run Option A in sweep first. If ADX gate shows consistent improvement in candidates, implement Option B in live.

---

## 5. Other Research Findings (Lower Priority)

### Pool-depth slippage gap

The backtest empirical cost model uses observed trade costs — but those trades all passed the live `checkEntryImpact` gate (filters out high-slippage entries). The sweep replays all signals including ones the live bot would reject. This means sweep overstates trade count and understates average cost per trade. Not immediately actionable, but worth documenting as a systematic backtest bias.

### DSR (Deflated Sharpe Ratio)

When selecting params from sweep across N total trials (all tokens × all param combos), the expected maximum Sharpe from noise alone scales with log(N). Current approach of `score + PF ≥ 1.2 + N ≥ 10` already approximates this practically. Full DSR implementation would require tracking total trial count across all sweep runs — overhead not justified given the Sharpe instability issue already flagged by Codex.

### Exit threshold sanity: `exit` field in TokenStrategy

`TokenStrategy.params.exit` exists in the type and in `live-strategy-map.v1.json`, but is documented as "stored for reference (sweep source); live exit driven by sl/tp". Codex question: **should this field be removed from the live type, or is it useful to keep for future indicator-based exit implementation?** Keeping it as a placeholder is reasonable if we plan to implement RSI-based exits in live. Removing it reduces confusion.

---

## 6. Codex Review Questions

1. **`rsi-crsi-midpoint-exit` template design** — any issues with no `takeProfitPct` on the strategy object? The engine's SL fires from `stopLossPct`; the sell signal fires from `rsi > 50`. Is there a case where positions never exit (RSI never recovers to 50 AND price never hits SL)?

2. **ADX gate — Option A first** — agree with sweep-before-live approach? Or is the evidence for ADX gating strong enough to implement in live directly?

3. **Live vs. backtest disconnect** — is the divergence (indicator exit in sweep vs. price-only in live) causing enough bias to be worth fixing? If so: should we remove indicator-exit conditions from sweep templates for accurate modeling, or add indicator exits to live?

4. **`exit` field in TokenStrategy** — keep or remove? If keep, should it be wired up to an actual exit check in position-manager for per-token positions?

5. **Trade frequency impact of midpoint exit** — RSI-50 exit will produce shorter hold times than RSI > 85+ exit. On PIPPIN with ~8.7 trades/day baseline, shorter holds could allow re-entry sooner. Does this interact badly with any existing re-entry lockout logic?
